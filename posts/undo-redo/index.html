<!doctype html>
<html lang="en">
<head>
        <base href="../..">
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="description" content="Some code crumbs dropped along my coding <path/>">
        <meta name="keywords" content="Eleventy, Web Components, JS, HTML, JavaScript, SVG">
        <meta name="generator" content="Eleventy">
        <meta name="author" content="Pierre Plaissy">

        <meta property="og:title" content="How to code a drawing undo/redo feature">
        <meta property="og:type" content="article">
        <meta property="og:URL" content="https://code-crumbs.pplaissy.fr/posts/undo-redo/">
        <meta property="og:image" content="https://code-crumbs.pplaissy.fr/assets/img/undo-redo/thumbnail.svg">
        <meta property="og:description" content="An undo/redo drawing feature from scratch, step by step and with a really cool and innovative bonus">

        <title>Code crumbs</title>
        <link rel="icon" href="assets/img/favicon.ico">
        <link rel="stylesheet" href="assets/css/main.css">
        <link rel="stylesheet" href="assets/css/posts.css">
    </head>
    <body>
        <nav class="header">
  <div class="avatar">
    <img src="assets/img/me.png" alt="me" class="profile-img mr">
    <!-- <span class="copy" @html="'&copy; ' + currentYear() + ' P. Plaissy'"></span> -->
    <!-- <span>P. Plaissy</span> -->
  </div>
  <div class="title">
    <div class="main">
      <a href="#" class="nav-item mr">code crumbs</a>
      <a href="https://www.linkedin.com/in/pierreplaissy/" aria-label="LinkedIn" target="_blank" rel="noopener noreferrer" class="linkedin">
    <img src="assets/img/linkedin.svg" alt="LinkedIn" width="24" height="24" class="mb-1">
</a>

    </div>
    <!-- <div class="epigraph">
      <span>Some code crumbs dropped along my coding &lt;path&#47;&gt;</span>
    </div> -->
  </div>
</nav>
<link rel="stylesheet" href="assets/css/header.css">

        <div class="main-container">
            <h1>How to code a drawing undo/redo feature</h1>
<article><p>The principle is well known so there's no need to describe it. Let's just remember that we're in the special environment of an SVG editor here, and that undo/redo operations apply to to graphical entities, lines, circles, paths and so on.</p>
<p>A glimpse in action :</p>
<p><img src="assets/img/undo-redo/undo01.gif" alt="undoing"></p>
<h2>Drawing action</h2>
<p>If you want to undo a modification to a entity, you must of course have stored the entity's state before the modification. And if you want to restore an undone modification, you must first have stored the entity's modified state.</p>
<p>Let's set up a <strong>DrawingAction</strong> class designed to store the modification of an entity, i.e. both its "<strong>prevState</strong>" state before modification and its "<strong>nextState</strong>" state after modification. We also store "<strong>entity</strong>", a pointer to the entity itself, so we can change its state right here by applying "<strong>prevState</strong>" or "<strong>nextState</strong>" as appropriate.</p>
<pre class="language-typescript"><code class="language-typescript"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">DrawingAction</span> <span class="token punctuation">{</span>
    entity<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">;</span>
    prevState<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">;</span>
    nextState<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">;</span>
    status<span class="token operator">:</span> UndoStateEnum <span class="token operator">=</span> UndoStateEnum<span class="token punctuation">.</span>pending<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>To reverse a state, you need to know "<strong>status</strong>" of the current state. I use a "<strong>UndoStateEnum</strong>" enum that lets me know whether the modification is in progress, undone or restored:</p>
<pre class="language-typescript"><code class="language-typescript"><span class="token keyword">export</span> <span class="token keyword">enum</span> UndoStateEnum <span class="token punctuation">{</span>
    pending <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
    restored<span class="token punctuation">,</span>
    undone
<span class="token punctuation">}</span></code></pre>
<h3>Starting an update</h3>
<p>A <strong>DrawingAction</strong> is created when a modification action begins. A [service](#undo service), which we'll see a little later, receives the storage request and generates as many <strong>DrawingActions</strong> as there are selected entities to be modified.</p>
<pre class="language-typescript"><code class="language-typescript"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">DrawingAction</span> <span class="token punctuation">{</span>
	<span class="token operator">...</span>
    cudOp<span class="token operator">:</span> UndoCUDOpEnum<span class="token punctuation">;</span>
    
    <span class="token function">constructor</span><span class="token punctuation">(</span>e<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span> cudOp<span class="token operator">:</span> UndoCUDOpEnum<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token keyword">this</span><span class="token punctuation">.</span>entity <span class="token operator">=</span> e<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>cudOp <span class="token operator">=</span> cudOp<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>prevState <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">cloneState</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>The ctor receives the entity, which is of type any. I could have given it the base type of my entities but I preferred to keep it generic at this stage, as this can be used in different contexts. The "<strong>cudOp</strong>" indicates the type of CUD (Create, Update, Delete) operation started on the selected entities. We need this information because it's not the same thing to restore the position of an entity as to reinsert it if it has been deleted or to delete it if it has been created.</p>
<p>Here too I use an enumeration :</p>
<pre class="language-typescript"><code class="language-typescript"><span class="token keyword">export</span> <span class="token keyword">enum</span> UndoCUDOpEnum <span class="token punctuation">{</span>
    update <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
    create<span class="token punctuation">,</span>
    <span class="token keyword">delete</span>
<span class="token punctuation">}</span></code></pre>
<p>The <strong>DrawingAction</strong> ctor initializes the current state "<strong>prevState</strong>" with a clone of the entity.</p>
<pre class="language-typescript"><code class="language-typescript"><span class="token keyword">private</span> <span class="token function">cloneState</span><span class="token punctuation">(</span>e<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">any</span> <span class="token punctuation">{</span>
    <span class="token comment">// here you need some kind of object cloning method, for example :</span>
    <span class="token keyword">const</span> result<span class="token operator">:</span> <span class="token builtin">any</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> allPropertyNames <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">getOwnPropertyNames</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    allPropertyNames<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>p <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        result<span class="token punctuation">[</span>p<span class="token punctuation">]</span> <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">getOwnPropertyDescriptor</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token operator">?.</span>value<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>"<strong>prevState</strong>" may seem a rather inappropriate name for the current state, but it must be remembered that when an undo operation is performed, the two states "<strong>prevState</strong>" and "<strong>nextState</strong>" will have been exchanged and "<strong>prevState</strong>" will effectively correspond to the state preceding the undo operation.</p>
<h3>Ending an update</h3>
<p>When a modification operation is complete, the [service](#undo service) set the new state of the entities for each <strong>DrawingAction</strong> :</p>
<pre class="language-typescript"><code class="language-typescript"><span class="token function">store</span><span class="token punctuation">(</span>e<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>nextState <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">cloneState</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> UndoStateEnum<span class="token punctuation">.</span>restored<span class="token punctuation">;</span>
    <span class="token comment">// return false if the entity has no changes</span>
    <span class="token keyword">return</span> prevState <span class="token operator">!==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>nextState<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>We clone the state of the modified entity as we did for <strong>prevState</strong> in the constructor. For example, <strong>status</strong>, which was <strong>UndoStateEnum.pending</strong> in the constructor, becomes <strong>UndoStateEnum.restored</strong>. Restored because there is no difference between a current state after a modification and a restored state after a redo. This is the same name ambiguity we saw above with <strong>prevState</strong>..</p>
<p>Why is it necessary to pass <code>(e: any)</code> to the <strong>push</strong> function since entity has already been stored at initialisation. Remember it's a pointer, so its state is the modified state. We could just as easily do <code>this.nextState = this.cloneState(this.entity);</code> couldn't we? Well, no, because in the case of an insertion operation, the entity doesn't yet exist when <strong>DrawingAction</strong> is initialised. <strong>entity</strong> and <strong>prevState</strong> are undefined. And here, conversely, it's during a delete operation that <strong>e</strong> and <strong>nextState</strong> are undefined, because at that point the entity no longer exists..</p>
<p>This function returns false if the two states are identical. This indicates that the entity has not been modified, which occurs if the modification operation has been cancelled by the user before being completed. This return value allows the [service](#undo service) to know whether it should keep the <strong>DrawingAction</strong> or not.</p>
<h3>Undoing / redoing</h3>
<p>Finally, we still have to write the two methods undo and redo, which is quite straightforward, as all we have to do is swap the two states and change the status.</p>
<pre class="language-typescript"><code class="language-typescript"><span class="token function">undo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">switchState</span><span class="token punctuation">(</span>UndoStateEnum<span class="token punctuation">.</span>undone<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">redo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">switchState</span><span class="token punctuation">(</span>UndoStateEnum<span class="token punctuation">.</span>restored<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token function">switchState</span><span class="token punctuation">(</span>status<span class="token operator">:</span> UndoStateEnum<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> tmp <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>prevState<span class="token punctuation">;</span>
    <span class="token comment">// This is a straightforward but unsafe approach. We may loose nested types. </span>
    <span class="token comment">// For production purposes, it should be replaced by a deep cloning method.</span>
    Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>entity<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>prevState<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>prevState <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>nextState<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>nextState <span class="token operator">=</span> tmp<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> status<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<h2>Undo service</h2>
<p>Let's move on to the service that manages the stock flow.</p>
<p><strong>UndoService</strong> is a store for the successive states of modified entities and allows these states to be scrolled forwards or backwards.</p>
<p>The sequence of successive states of the entities is like a stop-motion film. Undo means playing the film backwards. Redo means playing it forwards again. Undo stops when there are no more operations to undo, i.e. when you are on the first frame. Redo stops when there are no more actions to restore, i.e. when you are on the last frame.</p>
<p>The service is initialized in the parent model, which imposes a maximum number of operations to be recorded. Passing this parameter to the constructor allows you, if you wish, to make it an adjustable input parameter.</p>
<pre class="language-typescript"><code class="language-typescript"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">UndoService</span> <span class="token punctuation">{</span>
	<span class="token operator">...</span>
    maxActions<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>

    <span class="token function">constructor</span><span class="token punctuation">(</span>maxActions<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>maxActions <span class="token operator">=</span> maxActions<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<h3>Recording actions</h3>
<p>When modifications are started, the service receives a request to initialise storage. The service uses two tables, one for temporary storage until the modification actions have been completed, "<strong>pending</strong>", and one for permanent storage once the modification has been completed, "<strong>actions</strong>".</p>
<p>The service creates a <strong>DrawingAction</strong> for each entity being modified. When the modification is a creation or a deletion, the action is immediately completed and placed in the <strong>actions</strong> array, otherwise it is placed in the <strong>pending</strong> temporary array. Note that the <strong>storeAction</strong> method ensures that the actions array does not exceed the size limit declared when the service was initialized.</p>
<pre class="language-typescript"><code class="language-typescript">actions<span class="token operator">:</span> DrawingAction<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
pending<span class="token operator">:</span> DrawingAction<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token function">start</span><span class="token punctuation">(</span>es<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> cudOp<span class="token operator">:</span> UndoCUDOpEnum <span class="token operator">=</span> UndoCUDOpEnum<span class="token punctuation">.</span>update<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    <span class="token comment">// store a temp array of entities current state</span>
    es<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>e <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> newAction <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DrawingAction</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> cudOp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>cudOp <span class="token operator">!==</span> UndoCUDOpEnum<span class="token punctuation">.</span>update<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// occurs when an entity is inserted or deleted</span>
            <span class="token comment">// in this case, the action is immediately stored</span>
            newAction<span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">storeAction</span><span class="token punctuation">(</span>newAction<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>pending<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>newAction<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token function">storeAction</span><span class="token punctuation">(</span>a<span class="token operator">:</span> DrawingAction<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    <span class="token comment">// move pending action to effective action</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>actions<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// drop first action if reach maximum storage</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">checkMax</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token function">checkMax</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>actions<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>maxActions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>actions <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>actions<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>When the modifications are complete, the service receives a request for definitive storage and the temporary table is cleaned out. Of course, this method is never used to create or delete entities.</p>
<pre class="language-typescript"><code class="language-typescript"><span class="token function">store</span><span class="token punctuation">(</span>es<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    <span class="token comment">// store the entities new state</span>
    es<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>e <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// entity should be found in temp array</span>
        <span class="token keyword">const</span> a <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pending<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>x<span class="token operator">=&gt;</span> x<span class="token punctuation">.</span>entity<span class="token punctuation">.</span>entityId <span class="token operator">===</span> e<span class="token punctuation">.</span>entityId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// store the new entity state if entity has changes</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>a<span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">storeAction</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// clear temp array</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>pending <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>If the user cancels the modification he is currently making, the service receives a cancellation request and empties the temporary table.</p>
<pre class="language-typescript"><code class="language-typescript"><span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    <span class="token comment">// update abort, clear temp array</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>pending <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<h3>Rewind to undo</h3>
<p>As we have seen, undoing is like playing the modification film backwards. To find out if there are any images left to rewind, we filter actions by their <strong>UndoStateEnum</strong> status. This gives you a sort of cursor position on the timeline.</p>
<pre class="language-typescript"><code class="language-typescript"><span class="token function">undoLast</span><span class="token punctuation">(</span>ids<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> undoable <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">undoable</span><span class="token punctuation">(</span>ids<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// may be there is no more action to undo</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>undoable<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> last <span class="token operator">=</span> undoable<span class="token punctuation">[</span>undoable<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>last<span class="token punctuation">.</span>cudOp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> UndoCUDOpEnum<span class="token punctuation">.</span>create<span class="token operator">:</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>deleteRequested<span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">deleteRequested</span><span class="token punctuation">(</span>last<span class="token punctuation">.</span>entity<span class="token punctuation">.</span>entityId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> UndoCUDOpEnum<span class="token punctuation">.</span>delete<span class="token operator">:</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>createRequested<span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createRequested</span><span class="token punctuation">(</span>last<span class="token punctuation">.</span>entity<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    last<span class="token punctuation">.</span><span class="token function">undo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token function">undoable</span><span class="token punctuation">(</span>ids<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> DrawingAction<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">able</span><span class="token punctuation">(</span>UndoStateEnum<span class="token punctuation">.</span>restored<span class="token punctuation">,</span> ids<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token function">able</span><span class="token punctuation">(</span>status<span class="token operator">:</span> UndoStateEnum<span class="token punctuation">,</span> ids<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> DrawingAction<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ids <span class="token operator">&amp;&amp;</span> ids<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>actions<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>x<span class="token operator">=&gt;</span> ids<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>entity<span class="token punctuation">.</span>entityId<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> x<span class="token punctuation">.</span>status <span class="token operator">===</span> status<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>actions<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>x<span class="token operator">=&gt;</span> x<span class="token punctuation">.</span>status <span class="token operator">===</span> status<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>If the action to be undone is of type <strong>UndoCUDOpEnum.update</strong>, there's no problem, it's simply a matter of inverting the states of the <strong>DrawingAction</strong>, it's the <code>last.undo()</code> instruction. On the other hand, if the modification is of type <strong>UndoCUDOpEnum.create</strong> or <strong>UndoCUDOpEnum.delete</strong>, the service cannot handle the state inversion, as the entity must either be reinserted into the drawing or deleted. The only thing the service can do is send a request to update the drawing. This request is listened to by the parent model, which performs the operation.</p>
<p>The service calls a function which acts as an event. It is not defined in the service, but by the parent model, which therefore listens to it in some way.</p>
<pre class="language-typescript"><code class="language-typescript"><span class="token comment">// UndoService side</span>
createRequested<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">(</span>state<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
deleteRequested<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">(</span>id<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">;</span>

<span class="token comment">// parent model side</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>undoService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UndoService</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>undoService<span class="token punctuation">.</span><span class="token function-variable function">createRequested</span> <span class="token operator">=</span> <span class="token punctuation">(</span>entity<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// instructions to insert entity in the drawing</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>drawing<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>entity<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>undoService<span class="token punctuation">.</span><span class="token function-variable function">deleteRequested</span> <span class="token operator">=</span> <span class="token punctuation">(</span>id<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// instructions to remove entity from the drawing</span>
    <span class="token keyword">const</span> i <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>drawing<span class="token punctuation">.</span>entities<span class="token punctuation">.</span><span class="token function">findIndex</span><span class="token punctuation">(</span>x<span class="token operator">=&gt;</span> x<span class="token punctuation">.</span>entityId <span class="token operator">===</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>drawing<span class="token punctuation">.</span>entities<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<h3>Forward to redo</h3>
<p>Nothing in particular to say here. The film is replayed right side up from the current position. It's exactly the same principle as for undo.</p>
<pre class="language-typescript"><code class="language-typescript"><span class="token function">redoLast</span><span class="token punctuation">(</span>ids<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> redoable <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">redoable</span><span class="token punctuation">(</span>ids<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// may be ther is no more action to redo</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>redoable<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token comment">// undo is backward, redo is forward, so we take the first</span>
    <span class="token keyword">const</span> first <span class="token operator">=</span> redoable<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>first<span class="token punctuation">.</span>cudOp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> UndoCUDOpEnum<span class="token punctuation">.</span>create<span class="token operator">:</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>createRequested<span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createRequested</span><span class="token punctuation">(</span>first<span class="token punctuation">.</span>entity<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> UndoCUDOpEnum<span class="token punctuation">.</span>delete<span class="token operator">:</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>deleteRequested<span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">deleteRequested</span><span class="token punctuation">(</span>first<span class="token punctuation">.</span>entity<span class="token punctuation">.</span>entityId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    first<span class="token punctuation">.</span><span class="token function">redo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token function">redoable</span><span class="token punctuation">(</span>ids<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> DrawingAction<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">able</span><span class="token punctuation">(</span>UndoStateEnum<span class="token punctuation">.</span>undone<span class="token punctuation">,</span> ids<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<h2>To sum up</h2>
<p>You see, it takes surprisingly few codes to achieve this feature. Frankly, I expected it to be a lot more complicated when I began working on it.</p>
<p>You can find the whole thing on the github repo.</p>
<h2>Super bonus</h2>
<p>Let's take a look at this little bonus that I've been dangling in front of you all along.</p>
<p>One thing that often annoys me when I'm drawing is when I realize that I shouldn't have, say, moved these elements a little earlier. To go back, I then have to undo everything I've done since, which I don't want to do. And I'm forced to work around the problem by taking a copy of the elements whose state I'd like to recover after reverting. But this is sometimes too complicated and just as annoying as losing unsaved changes.</p>
<p>It's a pity that it's not possible to undo only operations concerning specific entities üòÅ.</p>
<p>Yes, you guessed it, that's the super bonus!</p>
<p>You may have wondered why the <strong>undoLast</strong> and <strong>redoLast</strong> methods expect an array of <code>ids: string[]</code> identifiers. And indeed, it seems pointless, since the service already knows which entities are present on the movie. Well, this way it becomes possible to apply forward or reverse state changes to only some of them.</p>
<p>How does it work? If no entities are selected on the drawing, then <strong>undo</strong> or <strong>redo</strong> apply to all actions recorded in <strong>UndoService</strong>. If one or more entities are selected on the drawing, only these will be affected.</p>
<p>A killer low code feature, isn't it ? Watch it in action !</p>
<p>Let's say I've modified this series of lines and want to go back only on the middle four...</p>
<p><img src="assets/img/undo-redo/undo02.gif" alt="undoing"></p>
<p>Thanks for checking by. Yoiu can find the code on <a href="https://github.com/pplaissy/undo-redo">github</a>.</p>
</article>
        </div>
    
</body>
</html>